<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Candlestick Climber - Trading Zone Game</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #0d1117; /* Dark GitHub-like background */
            font-family: 'Arial', sans-serif;
            margin: 0;
            overflow: hidden;
            color: #c9d1d9; /* Light grey text */
        }
        #game-container {
            position: relative; /* For positioning messages */
            width: 400px;
            height: 600px;
            border: 2px solid #30363d;
            background: linear-gradient(to bottom, #161b22, #0d1117); /* Subtle gradient */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            overflow: hidden; /* Crucial for candle scrolling */
        }
        #gameCanvas {
            display: block;
            background-color: transparent; /* Canvas is see-through */
        }
        .ui-container {
            display: flex;
            justify-content: space-between;
            width: 95%;
            max-width: 400px;
            padding: 8px 15px;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin: 15px 0;
            box-sizing: border-box;
        }
        .score {
            font-size: 1em;
            font-weight: bold;
        }
        #heightScore { color: #f0b90b; } /* Gold-like color */
        #disciplineScore { color: #58a6ff; } /* Blue accent */

        #messageArea {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(30, 36, 43, 0.85);
            color: #c9d1d9;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            z-index: 10;
            opacity: 0; /* Start hidden */
            transition: opacity 0.5s ease-out;
        }
         #messageArea.visible {
            opacity: 1;
        }

        #startRestartButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #c9d1d9;
            background-color: #238636; /* Green button */
            border: 1px solid #30363d;
            border-radius: 6px;
            cursor: pointer;
            z-index: 20;
            transition: background-color 0.2s ease;
        }
         #startRestartButton:hover {
             background-color: #2ea043;
        }
        #startRestartButton.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="ui-container">
        <div id="heightScore" class="score">Altezza: 0 m</div>
        <div id="disciplineScore" class="score">Disciplina: 10</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
        <div id="messageArea"></div>
        <button id="startRestartButton">Inizia</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const messageArea = document.getElementById('messageArea');
        const heightScoreDisplay = document.getElementById('heightScore');
        const disciplineScoreDisplay = document.getElementById('disciplineScore');
        const startRestartButton = document.getElementById('startRestartButton');

        // Game Constants
        const GRAVITY = 0.35;
        const JUMP_FORCE = -8;
        const PLAYER_WIDTH = 20;
        const PLAYER_HEIGHT = 20;
        const PLAYER_COLOR = "#f0b90b"; // Gold
        const CANDLE_MIN_WIDTH = 40;
        const CANDLE_MAX_WIDTH = 100;
        const CANDLE_MIN_HEIGHT = 10;
        const CANDLE_MAX_HEIGHT = 40;
        const GREEN_CANDLE_COLOR = "#238636"; // Green
        const RED_CANDLE_COLOR = "#da3633";   // Red
        const INITIAL_SCROLL_SPEED = 1.5;
        const MAX_SCROLL_SPEED = 4;
        const SPEED_INCREMENT = 0.0005;
        const VERTICAL_SPACING_MIN = 80;
        const VERTICAL_SPACING_MAX = 130;
        const STARTING_DISCIPLINE = 10;
        const MAX_DISCIPLINE = 20; // Cap discipline

        // Game State
        let player;
        let candles = [];
        let scrollSpeed = INITIAL_SCROLL_SPEED;
        let cameraY = 0; // Simulates camera moving up with the player
        let maxHeight = 0;
        let disciplineScore = STARTING_DISCIPLINE;
        let gameRunning = false;
        let gameOver = false;
        let lastCandleY = canvas.height; // Position for the next candle
        let lastMessageTime = 0;

        class Player {
            constructor() {
                this.x = canvas.width / 2 - PLAYER_WIDTH / 2;
                this.y = canvas.height - PLAYER_HEIGHT - 50; // Start near bottom
                this.velocityY = 0;
                this.width = PLAYER_WIDTH;
                this.height = PLAYER_HEIGHT;
                this.onCandle = null; // Reference to the candle the player is on
            }

            jump() {
                // Can only jump if on a candle
                if (this.onCandle) {
                    this.velocityY = JUMP_FORCE;
                    this.onCandle = null; // Player is now airborne
                }
            }

            applyGravity() {
                 if (!this.onCandle) {
                    this.velocityY += GRAVITY;
                    this.y += this.velocityY;
                 } else {
                     // Stick to the candle if on one (adjust Y based on candle scroll)
                     this.y = this.onCandle.y - this.height;
                     this.velocityY = 0; // No vertical speed when on candle
                 }
            }

             updatePosition(scrollDelta) {
                 if (this.onCandle) {
                     this.y -= scrollDelta; // Move with the candle
                     // Update player's x based on candle movement (if candles moved horizontally)
                     // this.x = this.onCandle.x + this.onCandle.width / 2 - this.width / 2;
                 }
             }


            draw() {
                ctx.fillStyle = PLAYER_COLOR;
                // Simple rectangle for now, could be an image/icon
                ctx.fillRect(this.x, this.y - cameraY, this.width, this.height);
                ctx.strokeStyle = "#0d1117";
                ctx.strokeRect(this.x, this.y - cameraY, this.width, this.height);
            }
        }

        class Candle {
            constructor(y) {
                this.isGreen = Math.random() > 0.4; // 60% chance of green candle (slight upward bias)
                this.width = Math.random() * (CANDLE_MAX_WIDTH - CANDLE_MIN_WIDTH) + CANDLE_MIN_WIDTH;
                this.height = Math.random() * (CANDLE_MAX_HEIGHT - CANDLE_MIN_HEIGHT) + CANDLE_MIN_HEIGHT;
                this.x = Math.random() * (canvas.width - this.width); // Random horizontal position
                this.y = y;
                this.color = this.isGreen ? GREEN_CANDLE_COLOR : RED_CANDLE_COLOR;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y - cameraY, this.width, this.height);
                // Optional: Draw wicks later
            }
        }

        function spawnInitialCandles() {
            candles = [];
            lastCandleY = canvas.height - 50; // Start near bottom
            // Spawn a base candle
             candles.push(new Candle(lastCandleY));
             candles[0].width = canvas.width; // Make base wide
             candles[0].x = 0;
             candles[0].isGreen = true; // Always start green
             candles[0].color = GREEN_CANDLE_COLOR;

            // Spawn initial screen full of candles
            while (lastCandleY > -canvas.height) { // Generate enough to fill more than screen
                spawnCandle();
            }
        }


        function spawnCandle() {
            const newY = lastCandleY - (Math.random() * (VERTICAL_SPACING_MAX - VERTICAL_SPACING_MIN) + VERTICAL_SPACING_MIN);
            candles.push(new Candle(newY));
            lastCandleY = newY;
        }

        function updateCandles(scrollDelta) {
             candles.forEach(candle => {
                candle.y += scrollDelta; // Scroll candles down
            });

             // Remove candles below the screen
            candles = candles.filter(candle => candle.y - cameraY < canvas.height + 50); // Keep some buffer

             // Spawn new candles if needed
             if (candles.length > 0 && candles[candles.length - 1].y - cameraY > -50) {
                 spawnCandle();
             }
        }


         function checkCollisions() {
             let landedOnCandle = null;
             let isFalling = player.velocityY > 0; // Check if player is moving downwards

            if (isFalling) {
                candles.forEach(candle => {
                     // Check horizontal overlap
                     const overlapX = player.x < candle.x + candle.width && player.x + player.width > candle.x;
                     // Check vertical collision: feet are between candle top and candle top + some buffer
                     const playerFeet = player.y + player.height;
                     const onTop = playerFeet >= candle.y && playerFeet < candle.y + candle.height / 2 + Math.abs(player.velocityY); // Feet land on top half

                    if (overlapX && onTop) {
                        landedOnCandle = candle;
                    }
                });
            }


             if (landedOnCandle && !player.onCandle) { // Check if just landed
                 player.onCandle = landedOnCandle;
                 player.y = landedOnCandle.y - player.height; // Snap to top
                 player.velocityY = 0;

                 // Score discipline based on candle color
                 if (landedOnCandle.isGreen) {
                     disciplineScore = Math.min(MAX_DISCIPLINE, disciplineScore + 1); // Cap discipline
                     showMessage("Disciplinato! Atterraggio su candela verde.", "#238636");
                 } else {
                     disciplineScore -= 2; // Penalty for landing on red
                     showMessage("Indisciplinato! Atterraggio su candela rossa. -2 Disciplina", "#da3633");
                 }
             }
         }

        function updateGame() {
            if (!gameRunning || gameOver) return;

            let scrollDelta = scrollSpeed;
            player.applyGravity();

            // Camera follows player upwards (adjust scrolling)
            // Keep player roughly in the lower third of the screen
             const targetCameraY = player.y - (canvas.height * 2/3);
             // Smooth camera movement
             cameraY += (targetCameraY - cameraY) * 0.05;
             // Clamp cameraY so it doesn't go below 0
             cameraY = Math.max(0, cameraY);


            // Actual scrolling applied to elements
            scrollDelta = scrollSpeed + (player.y < cameraY + canvas.height / 2 ? (cameraY + canvas.height / 2 - player.y) * 0.1 : 0); // Scroll faster if player is high

             updateCandles(scrollDelta);
             player.updatePosition(scrollDelta); // Update player Y pos based on scrolling
             checkCollisions();

             // Increase speed
             scrollSpeed = Math.min(MAX_SCROLL_SPEED, scrollSpeed + SPEED_INCREMENT);


             // Update Max Height (P&L simulation)
             // Height calculation needs refinement - should be based on total upward progress
             let currentHeightMeters = Math.floor(maxHeight / 50); // Arbitrary scale for display
             maxHeight = Math.max(maxHeight, canvas.height - player.y); // Higher Y value is lower on screen
             heightScoreDisplay.textContent = `Altezza: ${currentHeightMeters} m`;

            // Update Discipline UI
            disciplineScoreDisplay.textContent = `Disciplina: ${disciplineScore}`;

            // Game Over conditions
            if (player.y - cameraY > canvas.height) { // Fell off screen
                showMessage("Caduto! Gestisci meglio il rischio.", "#da3633");
                gameOver = true;
                gameRunning = false;
            }
            if (disciplineScore <= 0) {
                showMessage("Disciplina esaurita! Game Over.", "#da3633");
                 gameOver = true;
                 gameRunning = false;
             }

             if (gameOver) {
                 startRestartButton.textContent = "Riprova";
                 startRestartButton.classList.remove('hidden');
             }
        }

        function drawGame() {
            // Clear canvas (already transparent)
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            candles.forEach(candle => candle.draw());
            player.draw();

            if (gameRunning) {
                requestAnimationFrame(drawGame);
                updateGame();
            }
        }

        function handleInteraction() {
             if (!gameRunning && !gameOver) {
                 // This case should not happen if button handles start
             } else if (gameRunning) {
                 player.jump();
             } else if (gameOver) {
                 // This is handled by the button click now
             }
        }

        function showMessage(msg, color = "#c9d1d9", duration = 2500) {
             // Prevent message spamming
             const now = Date.now();
             if (now - lastMessageTime < 500) return; // Don't show message if last one was < 0.5s ago

             lastMessageTime = now;
             messageArea.textContent = msg;
             messageArea.style.color = color;
             messageArea.classList.add('visible');

             // Clear message after duration
             setTimeout(() => {
                 messageArea.classList.remove('visible');
             }, duration);
        }

        function startGame() {
             if (gameRunning) return;

             player = new Player();
             scrollSpeed = INITIAL_SCROLL_SPEED;
             cameraY = 0;
             maxHeight = 0;
             disciplineScore = STARTING_DISCIPLINE;
             gameOver = false;
             gameRunning = true;
             lastCandleY = canvas.height; // Reset for generation

             spawnInitialCandles();
             player.y = candles[0].y - player.height; // Place player on the base candle
             player.onCandle = candles[0];


             heightScoreDisplay.textContent = `Altezza: 0 m`;
             disciplineScoreDisplay.textContent = `Disciplina: ${disciplineScore}`;
             startRestartButton.classList.add('hidden'); // Hide button
             showMessage("Inizia la scalata! Salta sulle candele verdi.", "#58a6ff", 4000);

             requestAnimationFrame(drawGame);
        }

         // Event Listeners
         window.addEventListener('keydown', (e) => {
             if (e.code === 'Space' && gameRunning) {
                 player.jump();
                 e.preventDefault();
             }
         });
         canvas.addEventListener('touchstart', (e) => {
             if (gameRunning) {
                 player.jump();
                 e.preventDefault(); // Prevent screen scrolling on mobile
             }
         });
         // Button handles both start and restart
         startRestartButton.addEventListener('click', startGame);

        // Initial passive drawing (optional, can be removed if start button is enough)
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         // Maybe draw a title or static background element here before start


    </script>
</body>
</html>