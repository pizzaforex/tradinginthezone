<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader's Mind Codex - Edizione Avanzata</title>
    <style>
        /* --- Reset, Font, Variabili CSS --- */
        :root {
            --primary-color: #005ea6; /* Blu più intenso */
            --secondary-color: #1a4a7a;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #343a40;
            --text-muted: #6c757d;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-orange: #fd7e14;
            --accent-purple: #6f42c1;
            --accent-blue: #007bff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-bg);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 25px;
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- Contenitore Principale --- */
        .trader-dex {
            width: 1100px; max-width: 100%;
            min-height: 750px; background-color: #ffffff;
            border: 1px solid var(--border-color); border-radius: 15px;
            display: flex; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            position: relative; overflow: hidden;
        }

        /* --- Separatore Centrale --- */
        .trader-dex::before {
            content: ''; position: absolute; top: 0; left: 50%;
            transform: translateX(-50%); width: 1px; height: 100%;
            background-color: var(--border-color); z-index: 1;
        }

        /* --- Pannelli --- */
        .left-panel, .right-panel {
            width: 50%; height: auto; min-height: 750px;
            padding: 30px 35px; display: flex; flex-direction: column;
            position: relative;
        }
        .left-panel { border-right: 1px solid var(--border-color); }

        /* --- Intestazioni --- */
        .panel-header {
            font-size: 1.6em; font-weight: 600; color: var(--primary-color);
            margin-bottom: 25px; padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        /* --- Area Filtri/Ricerca --- */
        .filter-search-area { margin-bottom: 20px; }
        #search-input {
            width: 100%; padding: 10px 14px; margin-bottom: 12px;
            border: 1px solid #ced4da; border-radius: 6px; font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #search-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); }
        .filter-buttons button {
            padding: 7px 14px; margin-right: 6px; margin-bottom: 6px;
            border: 1px solid #adb5bd; border-radius: 18px;
            background-color: #e9ecef; color: #495057; cursor: pointer;
            transition: all 0.2s; font-size: 0.88em; font-weight: 500;
        }
        .filter-buttons button:hover { background-color: #dee2e6; border-color: #6c757d; }
        .filter-buttons button.active {
            background-color: var(--primary-color); color: white; border-color: var(--primary-color);
        }

        /* --- Schermi --- */
        .screen {
            background-color: #ffffff; border: 1px solid #e9ecef;
            border-radius: 8px; padding: 18px; flex-grow: 1;
            overflow: hidden; display: flex; flex-direction: column;
            margin-bottom: 18px;
        }
        .list-screen { overflow-y: auto; }
        .detail-screen { overflow-y: auto; }

        /* --- Lista Concetti --- */
        #concept-list { list-style: none; padding: 0; margin: 0; }
        #concept-list li {
            padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid #f1f3f5; font-weight: 500; color: var(--text-color);
            transition: background-color 0.2s ease, transform 0.1s ease;
            border-radius: 5px; margin-bottom: 3px;
            display: flex; align-items: center; justify-content: space-between; /* Per indicatore letto */
        }
        #concept-list li:last-child { border-bottom: none; }
        #concept-list li:hover { background-color: #e7f5ff; transform: translateX(3px); }
        #concept-list li.active { background-color: var(--primary-color); color: white; font-weight: 600; transform: translateX(0); }
        #concept-list li.hidden { display: none; }
        .concept-item-content { display: flex; align-items: center; gap: 10px; }
        .read-indicator {
             font-size: 1.1em; color: transparent; /* Inizialmente invisibile */
             transition: color 0.3s; margin-left: 10px;
        }
        #concept-list li.read .read-indicator { color: var(--accent-green); }
        #concept-list li.active .read-indicator { color: #a2d9a1; } /* Verde più chiaro su sfondo blu */

        /* Icone Categoria */
        .category-indicator {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block;
            flex-shrink: 0; box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        .cat-mindset { background-color: var(--accent-blue); }
        .cat-risk { background-color: var(--accent-red); }
        .cat-beliefs { background-color: var(--accent-purple); }
        .cat-execution { background-color: var(--accent-green);}
        .cat-truths { background-color: var(--accent-orange); }
        .cat-exercise { background-color: #6c757d; } /* Grigio per esercizio */

        /* --- Dettagli Concetto --- */
        #concept-details { display: none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #concept-name {
            font-size: 1.8em; font-weight: 700; color: var(--secondary-color);
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);
        }
        #concept-description { font-size: 1.05em; line-height: 1.7; color: #495057; margin-bottom: 30px; }
        #concept-description p { margin-bottom: 15px; }
        #concept-description a { color: var(--primary-color); text-decoration: none; font-weight: 500; border-bottom: 1px dotted var(--primary-color); transition: border-bottom 0.2s; }
        #concept-description a:hover { border-bottom: 1px solid var(--primary-color); }
        #concept-description ol, #concept-description ul { margin-left: 20px; padding-left: 15px; margin-bottom: 15px; }

        /* Glossario Tooltip */
        .tooltip {
            position: relative;
            border-bottom: 1px dashed var(--primary-color);
            cursor: help;
            color: var(--primary-color); /* Rende il termine cliccabile più evidente */
            font-weight: 500;
        }
        .tooltip .tooltiptext {
            visibility: hidden; width: 250px; background-color: #555; color: #fff;
            text-align: center; border-radius: 6px; padding: 8px 10px; font-size: 0.9em;
            position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -125px; /* Centra */
            opacity: 0; transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after { /* Freccetta */
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        #concept-takeaways { padding-top: 20px; border-top: 1px dashed #ced4da; margin-bottom: 30px;}
        #concept-takeaways h3 { font-size: 1.25em; color: var(--secondary-color); margin-bottom: 15px; font-weight: 600; }
        #concept-takeaways ul { list-style-position: outside; list-style-type: '✓ '; margin-left: 5px; padding-left: 15px; color: var(--text-color); }
        #concept-takeaways li { margin-bottom: 12px; line-height: 1.65; padding-left: 5px; }

        /* Sezione Note */
        #concept-notes { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        #concept-notes h3 { font-size: 1.25em; color: var(--secondary-color); margin-bottom: 10px; font-weight: 600; }
        #notes-textarea {
            width: 100%; height: 120px; padding: 10px; border: 1px solid #ced4da;
            border-radius: 6px; font-family: inherit; font-size: 0.95em; resize: vertical;
            margin-bottom: 10px;
        }
        .notes-buttons button {
            padding: 8px 15px; margin-right: 10px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: 500; transition: background-color 0.2s;
        }
        #save-notes { background-color: var(--accent-green); color: white; }
        #save-notes:hover { background-color: #218838; }
        #clear-notes { background-color: #e9ecef; color: #495057; }
        #clear-notes:hover { background-color: #dee2e6; }

        .placeholder-text { color: var(--text-muted); font-style: italic; text-align: center; margin: auto; padding: 40px; }

        /* --- Sezione Valutazione --- */
        #assessment-toggle-button {
            display: block; width: 100%; padding: 12px 15px; margin-top: 20px;
            background-color: var(--accent-green); color: white; border: none; border-radius: 6px;
            font-size: 1.05em; font-weight: 500; cursor: pointer; text-align: center;
            transition: background-color 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #assessment-toggle-button:hover { background-color: #218838; }
        #assessment-area { display: none; margin-top: 20px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #ffffff; animation: fadeIn 0.5s; }
        #assessment-area h3 { color: var(--secondary-color); margin-bottom: 8px;}
        .assessment-question { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f3f5; }
        .assessment-question p { font-weight: 500; margin-bottom: 10px; line-height: 1.5; }
        .assessment-question label { margin-right: 20px; font-weight: 400; cursor: pointer; display: inline-block; padding: 3px 0;}
        .assessment-question input[type="radio"] { margin-right: 6px; vertical-align: middle; }
        #submit-assessment {
             padding: 10px 20px; margin-top: 20px; background-color: var(--primary-color); color: white;
             border: none; border-radius: 6px; font-size: 1em; cursor: pointer; transition: background-color 0.2s;
        }
        #submit-assessment:hover { background-color: var(--secondary-color); }
        #assessment-results { margin-top: 25px; padding: 18px; background-color: #e7f5ff; border-radius: 6px; border: 1px solid #b8daff; }
        #assessment-results h4 { margin-bottom: 12px; color: var(--secondary-color); font-size: 1.15em;}
        #assessment-results p { margin-bottom: 15px; line-height: 1.6;}
        #assessment-actions { margin-top:15px; padding-top: 15px; border-top: 1px dashed #b8daff;}
        #assessment-actions h5 { margin-bottom: 10px; font-weight: 600;}
        #assessment-actions ul { list-style: disc; margin-left: 20px; padding-left: 10px; font-size: 0.95em;}
        #assessment-actions li { margin-bottom: 8px;}
        #reset-assessment {
            font-size: 0.9em; color: var(--primary-color); cursor: pointer; text-decoration: none;
            margin-top: 15px; display: inline-block; border-bottom: 1px dotted var(--primary-color);
        }
        #reset-assessment:hover { border-bottom: 1px solid var(--primary-color); }


        /* --- Controlli Decorativi --- */
        .controls { display: flex; justify-content: flex-start; gap: 10px; padding: 20px 0 0 0; }
        .button { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #adb5bd; background-color: #e9ecef; }
        .blue-light { background-color: #a0c4e4; } .green-light { background-color: #a2d9a1; }

        /* --- Media Query --- */
        @media (max-width: 1150px) {
             .trader-dex { flex-direction: column; height: auto; width: 95%; max-width: 700px; min-height: 0; }
             .trader-dex::before { display: none; }
             .left-panel, .right-panel { width: 100%; min-height: 450px; border-right: none; height: auto; padding: 25px; }
             .left-panel { border-bottom: 1px solid var(--border-color); }
             .panel-header { font-size: 1.4em; margin-bottom: 20px; }
             #concept-name { font-size: 1.6em; }
             .tooltip .tooltiptext { width: 200px; margin-left: -100px; } /* Adatta tooltip */
        }
         @media (max-width: 500px) {
             body { padding: 15px; }
             .left-panel, .right-panel { padding: 20px; min-height: 350px; }
             .panel-header { font-size: 1.3em; }
             #concept-name { font-size: 1.4em; }
             .filter-buttons button { padding: 6px 10px; font-size: 0.8em;}
             #assessment-toggle-button, #submit-assessment { font-size: 0.95em; padding: 10px;}
         }

    </style>
</head>
<body>

    <div class="trader-dex">
        <!-- Pannello Sinistro -->
        <div class="left-panel">
            <h2 class="panel-header">Trader's Mind Codex</h2>
            <div class="filter-search-area">
                <input type="text" id="search-input" placeholder="Cerca concetto...">
                <div class="filter-buttons">
                    <button data-category="all" class="active">Tutti</button>
                    <button data-category="Mindset">Mentalità</button>
                    <button data-category="Risk">Rischio</button>
                    <button data-category="Beliefs">Convinzioni</button>
                    <button data-category="Execution">Esecuzione</button>
                    <button data-category="Truths">Verità</button>
                    <button data-category="Exercise">Esercizio</button>
                </div>
            </div>
            <div class="screen list-screen">
                <ul id="concept-list"></ul>
            </div>
             <button id="assessment-toggle-button">Valutazione Mentalità</button>
            <div class="controls">
                <div class="button blue-light"></div>
                <div class="button green-light"></div>
            </div>
        </div>

        <!-- Pannello Destro -->
        <div class="right-panel">
            <h2 class="panel-header" id="right-panel-header">Dettagli Concetto</h2>
            <div class="screen detail-screen">
                <!-- Area Dettagli Concetto -->
                <div id="concept-details">
                    <h2 id="concept-name"></h2>
                    <div id="concept-description"></div>
                    <div id="concept-takeaways">
                        <h3>Punti Chiave / Azioni</h3>
                        <ul></ul>
                    </div>
                    <div id="concept-notes">
                         <h3>Note Personali</h3>
                         <textarea id="notes-textarea" placeholder="Scrivi qui le tue riflessioni o appunti su questo concetto..."></textarea>
                         <div class="notes-buttons">
                             <button id="save-notes">Salva Note</button>
                             <button id="clear-notes">Pulisci Note</button>
                         </div>
                     </div>
                </div>
                 <!-- Area Valutazione -->
                <div id="assessment-area">
                    <h3>Valutazione della Mentalità del Trader</h3>
                    <p style="font-size:0.9em; margin-bottom:20px; color:var(--text-muted);">Rispondi onestamente per un'auto-analisi. I risultati sono salvati solo localmente.</p>
                    <div id="assessment-questions"></div>
                    <button id="submit-assessment">Mostra Risultati</button>
                    <div id="assessment-results" style="display:none;">
                        <h4>Interpretazione Generale:</h4>
                        <p id="results-text"></p>
                         <div id="assessment-actions">
                             <h5>Suggerimenti:</h5>
                             <ul id="results-actions"></ul>
                         </div>
                        <span id="reset-assessment">Ripeti valutazione</span>
                    </div>
                </div>
                <!-- Placeholder -->
                <p class="placeholder-text" id="placeholder">Seleziona un concetto o apri la valutazione.</p>
            </div>
             <div class="controls" style="justify-content: flex-end;">
                <div class="button" style="background-color: #ffc107;"></div>
             </div>
        </div>
    </div>

    <script>
        // --- Elementi DOM ---
        const elements = {
            conceptList: document.getElementById('concept-list'),
            conceptDetails: document.getElementById('concept-details'),
            conceptName: document.getElementById('concept-name'),
            conceptDescription: document.getElementById('concept-description'),
            conceptTakeaways: document.getElementById('concept-takeaways').querySelector('ul'),
            conceptNotes: document.getElementById('concept-notes'),
            notesTextarea: document.getElementById('notes-textarea'),
            saveNotesButton: document.getElementById('save-notes'),
            clearNotesButton: document.getElementById('clear-notes'),
            placeholder: document.getElementById('placeholder'),
            searchInput: document.getElementById('search-input'),
            filterButtonsContainer: document.querySelector('.filter-buttons'),
            assessmentToggleButton: document.getElementById('assessment-toggle-button'),
            assessmentArea: document.getElementById('assessment-area'),
            rightPanelHeader: document.getElementById('right-panel-header'),
            assessmentQuestionsContainer: document.getElementById('assessment-questions'),
            submitAssessmentButton: document.getElementById('submit-assessment'),
            assessmentResultsContainer: document.getElementById('assessment-results'),
            resultsText: document.getElementById('results-text'),
            resultsActions: document.getElementById('results-actions'),
            resetAssessmentButton: document.getElementById('reset-assessment')
        };

        // --- DATI ---
        const conceptsData = [
             { id: 'prob_thinking', name: 'Pensare in Probabilità', category: 'Mindset', description: `<p>Il <span class="tooltip">mercato<span class="tooltiptext">L'arena collettiva dove compratori e venditori interagiscono.</span></span> genera pattern, ma l'esito di ogni singolo <span class="tooltip">edge<span class="tooltiptext">Un vantaggio statistico definito da un set di variabili di mercato.</span></span> è casuale. Il trader pro non prevede il singolo trade, ma sa che su molti trade, l'edge produrrà profitti.</p><p>Elimina la pressione di "aver ragione" e riduce l'impatto emotivo delle perdite (costo operativo).</p><p>Vedi anche: <a href="#accept_risk" onclick="handleInternalLink('accept_risk', event)">Accettare il Rischio</a>, <a href="#five_truths" onclick="handleInternalLink('five_truths', event)">Le Cinque Verità</a>.</p>`, takeaways: ["Ogni trade ha esito incerto, accettalo.", "Focalizzati sull'esecuzione corretta del tuo edge su una serie di trade (legge dei grandi numeri).", "Non dare peso emotivo eccessivo a gain/loss singoli.", "Misura il successo sull'applicazione disciplinata del metodo."] },
             { id: 'accept_risk', name: 'Accettare il Rischio', category: 'Risk', description: `<p>Non basta definire uno <span class="tooltip">stop loss<span class="tooltiptext">Un ordine preimpostato per chiudere una posizione a un certo livello di prezzo per limitare la perdita.</span></span>. Significa accettare *emotivamente* la possibilità di perdere, senza paura o disagio.</p><p>Solo così si opera oggettivamente. La <span class="tooltip">paura<span class="tooltiptext">L'emozione che sorge dalla percezione di una minaccia, che distorce il giudizio.</span></span> distorce la percezione e porta a errori.</p><p>Vedi anche: <a href="#prob_thinking" onclick="handleInternalLink('prob_thinking', event)">Pensare in Probabilità</a>, <a href="#discipline" onclick="handleInternalLink('discipline', event)">Autodisciplina</a>.</p>`, takeaways: ["Predefinisci il rischio monetario *prima* di entrare.", "Accetta la perdita come costo operativo, non fallimento personale.", "Lavora attivamente per neutralizzare la paura di sbagliare o perdere.", "La presenza di paura indica una non completa accettazione del rischio."] },
             { id: 'market_neutral', name: 'Il Mercato è Neutrale', category: 'Mindset', description: `<p>Il mercato non ha intenzioni, non ti conosce, non ti deve nulla. Genera solo informazioni (prezzi, volumi).</p><p>Attribuirgli intenzioni ("è contro di me") porta a interpretazioni emotive e decisioni errate.</p>`, takeaways: ["Smetti di personificare il mercato o vederlo come nemico/amico.", "Interpreta i dati oggettivamente, come feedback.", "Il mercato non ti deve nulla; sei tu a dover capitalizzare sulle opportunità.", "La tua reazione emotiva nasce dalle tue aspettative/credenze interne."] },
             { id: 'moment_unique', name: 'Ogni Momento è Unico', category: 'Mindset', description: `<p>Pattern simili non garantiscono esiti identici perché i partecipanti sono sempre diversi. Ogni "momento presente" nel mercato è unico.</p><p>Associare il presente al passato (specie se carico emotivamente) impedisce di vedere oggettivamente le opportunità attuali.</p><p>Vedi anche: <a href="#five_truths" onclick="handleInternalLink('five_truths', event)">Le Cinque Verità</a>.</p>`, takeaways: ["Evita di proiettare l'esito (positivo o negativo) dell'ultimo trade sull'attuale.", "Rimani focalizzato sulle informazioni che il mercato offre *ora*.", "Interiorizza la credenza che 'tutto può succedere'.", "Allenati a dissociare il momento presente dalle esperienze passate."] },
             { id: 'five_truths', name: 'Le Cinque Verità Fondamentali', category: 'Truths', description: `<p>La mentalità probabilistica si cristallizza in:</p><ol><li>Tutto può succedere.</li><li>Non serve sapere cosa succederà per fare soldi.</li><li>C'è una distribuzione casuale tra gain e loss per ogni edge definito.</li><li>Un edge è solo una probabilità maggiore che una cosa accada rispetto a un'altra.</li><li>Ogni momento nel mercato è unico.</li></ol><p>Interiorizzarle a livello funzionale è la chiave per operare senza paura.</p>`, takeaways: ["Ripeti, rifletti e medita regolarmente su queste verità.", "Identifica attivamente i conflitti tra queste verità e le tue credenze.", "Usa l'esercizio del Cap. 11 per integrarle.", "Osserva come il tuo stato emotivo cambia applicandole."] },
             { id: 'responsibility', name: 'Assumersi la Responsabilità', category: 'Mindset', description: `<p>Accetta al 100% che sei tu a generare i tuoi risultati (interpretazioni, decisioni, azioni). Il mercato offre solo il flusso di opportunità.</p><p>Incolpare fattori esterni blocca l'apprendimento e perpetua la frustrazione. La responsabilità ti dà il potere di cambiare.</p>`, takeaways: ["Mai incolpare il mercato, il broker, le news, ecc.", "Vedi ogni trade (soprattutto gli errori) come feedback sul tuo processo.", "Sei l'unica fonte dei tuoi successi e fallimenti nel trading.", "La responsabilità totale è il primo passo per la crescita costante."] },
             { id: 'beliefs_perception', name: 'Credenze e Percezione', category: 'Beliefs', description: `<p>Le <span class="tooltip">credenze<span class="tooltiptext">Concetti carichi di energia che definiscono la nostra realtà e guidano le nostre azioni.</span></span> agiscono come filtri. Percepiamo la realtà in modo coerente con esse, ignorando o distorcendo il resto.</p><p>Credenze limitanti (su rischio, perdita, successo, autostima) possono accecarci alle opportunità o indurci in errore.</p><p>Vedi anche: <a href="#responsibility" onclick="handleInternalLink('responsibility', event)">Assumersi la Responsabilità</a>.</p>`, takeaways: ["Diventa un osservatore consapevole delle tue credenze.", "Metti in discussione attivamente le credenze che generano emozioni negative o autosabotaggio.", "Adotta consapevolmente credenze allineate con le Cinque Verità.", "Modifica le credenze trasferendo energia attraverso focus, intenzione e azione coerente."] },
             { id: 'discipline', name: 'Autodisciplina', category: 'Execution', description: `<p>Non è un tratto innato, ma una *tecnica* mentale per reindirizzare l'attenzione verso un obiettivo scelto, superando conflitti interni.</p><p>È fondamentale per seguire le regole del proprio <span class="tooltip">sistema di trading<span class="tooltiptext">Un insieme definito di regole per identificare, eseguire e gestire i trade.</span></span>, gestire le emozioni e costruire fiducia.</p>`, takeaways: ["Definisci regole meccaniche e oggettive per il tuo edge.", "Impegnati a seguire le regole senza eccezioni per un campione (es. 20 trade).", "Usa la disciplina per riportare il focus quando emergono conflitti o paure.", "La disciplina costante costruisce fiducia, che riduce lo sforzo disciplinare futuro."] },
             { id: 'the_zone', name: 'Trading nella "Zona"', category: 'Mindset', description: `<p>Stato mentale di flusso: assenza di paura, fiducia serena, obiettività, focus sul momento presente. Azioni spontanee, senza sforzo, in sintonia col mercato.</p><p>È il risultato dell'accettazione del rischio e dell'operare da una prospettiva probabilistica, non un obiettivo da forzare.</p>`, takeaways: ["Non cercare di 'entrare' nella Zona, crea le condizioni mentali perché accada.", "Accetta pienamente il rischio e pensa in probabilità.", "Sii aperto e ricettivo a ciò che il mercato offre, senza aspettative rigide.", "Agisci senza esitazione quando il tuo edge si presenta."] },
             { id: 'exercise_ch11', name: 'Esercizio: Operare come un Casinò', category: 'Exercise', description: `<p>Questo esercizio (Cap. 11) è progettato per installare le 5 verità e creare consistenza.</p><p>Fasi chiave:</p><ol><li><strong>Scegli un Edge:</strong> Definisci variabili precise (entrata, uscita loss, uscita gain - opzionale ma utile -, gestione posizione). Deve essere meccanico.</li><li><strong>Accetta il Rischio:</strong> Determina il rischio per trade (es. % capitale o $ fissi) e assicurati di poter sostenere una serie di loss (es. 20) senza impatto emotivo/finanziario devastante.</li><li><strong>Opera in Campioni:</strong> Esegui i prossimi 20 trade che il tuo edge genera, senza eccezioni, senza cambiare parametri.</li><li><strong>Monitora e Rifletti:</strong> Valuta la tua capacità di seguire le regole, non il risultato P/L. Osserva pensieri ed emozioni contrastanti e usa l'autodisciplina.</li><li><strong>Ripeti:</strong> Continua con campioni di 20 trade finché operare secondo le regole diventa naturale e senza sforzo.</li></ol>`, takeaways: ["L'obiettivo è costruire fiducia nel metodo e in te stesso.", "La disciplina nell'esecuzione è più importante del P/L durante l'esercizio.", "Questo processo disattiva credenze conflittuali e rafforza la mentalità probabilistica.", "Richiede impegno e desiderio di consistenza sopra ogni altra cosa."] }
        ];
        const assessmentQuestions = [ // Ampliate e riformulate
            { q: "È fondamentale sapere la direzione futura del mercato per fare profitti.", score_for_agree: 0, focus: ['prob_thinking', 'five_truths'] },
            { q: "Esiste una strategia di trading che evita completamente le perdite.", score_for_agree: 0, focus: ['accept_risk', 'five_truths'] },
            { q: "Il successo nel trading dipende quasi esclusivamente dalla qualità dell'analisi di mercato.", score_for_agree: 0, focus: ['prob_thinking', 'beliefs_perception'] },
            { q: "Accetto le perdite come un costo naturale e inevitabile del trading.", score_for_agree: 1, focus: ['accept_risk', 'responsibility'] },
            { q: "Definisco sempre il mio massimo rischio accettabile prima di inserire un ordine.", score_for_agree: 1, focus: ['accept_risk', 'discipline'] },
            { q: "Mi sento a disagio ad entrare in un trade se non sono quasi certo che sarà vincente.", score_for_agree: 0, focus: ['prob_thinking', 'accept_risk'] },
            { q: "Più studio grafici e indicatori, minore sarà la probabilità di fare errori.", score_for_agree: 0, focus: ['beliefs_perception', 'prob_thinking'] },
            { q: "Tendo a rimuginare sugli errori passati o sulle opportunità mancate.", score_for_agree: 0, focus: ['moment_unique', 'responsibility'] },
            { q: "Il mio compito principale è identificare il mio edge e applicarlo con disciplina.", score_for_agree: 1, focus: ['discipline', 'exercise_ch11'] },
            { q: "Quando perdo, spesso sento che il mercato mi abbia 'preso di mira' o sia stato ingiusto.", score_for_agree: 0, focus: ['market_neutral', 'responsibility'] },
            { q: "Per essere un trader costante, devo essere mentalmente flessibile e adattarmi al mercato.", score_for_agree: 1, focus: ['the_zone', 'moment_unique'] },
            { q: "Anche dopo un trade molto profittevole, spesso penso a come avrei potuto guadagnare di più.", score_for_agree: 0, focus: ['accept_risk', 'beliefs_perception'] },
            { q: "Seguo le mie regole di trading meccanicamente, anche quando ho un forte 'sentimento' contrario.", score_for_agree: 1, focus: ['discipline', 'execution'] },
            { q: "Credo fermamente che l'esito del mio prossimo trade sia indipendente dai precedenti.", score_for_agree: 1, focus: ['prob_thinking', 'moment_unique', 'five_truths'] }
        ];

        // --- Stato Applicazione ---
        let currentFilter = 'all';
        let currentSearch = '';
        let currentConceptId = null; // Per sapere quale concetto è visualizzato per le note
        let reviewedConcepts = JSON.parse(localStorage.getItem('traderCodexReviewed')) || {};

        // --- FUNZIONI ---

        // Salva stato "letti"
        function saveReviewedState() {
            localStorage.setItem('traderCodexReviewed', JSON.stringify(reviewedConcepts));
        }

        // Marca concetto come letto
        function markAsRead(conceptId) {
            reviewedConcepts[conceptId] = true;
            saveReviewedState();
            // Aggiorna UI lista (senza rerender completo)
            const listItem = elements.conceptList.querySelector(`li[data-id="${conceptId}"]`);
            if (listItem) listItem.classList.add('read');
        }

        // Mostra dettagli concetto
        function displayConceptDetails(conceptId) {
            elements.assessmentArea.style.display = 'none';
            elements.conceptDetails.style.display = 'block';
            elements.rightPanelHeader.textContent = "Dettagli Concetto";
            currentConceptId = conceptId; // Salva ID corrente

            const concept = conceptsData.find(c => c.id === conceptId);
            if (!concept) { elements.placeholder.textContent = 'Concetto non trovato.'; elements.placeholder.style.display = 'block'; elements.conceptDetails.style.display = 'none'; return; }

            elements.placeholder.style.display = 'none';
            elements.conceptName.textContent = concept.name;
            elements.conceptDescription.innerHTML = concept.description; // Permette link e tooltip

            // Popola Takeaways
            elements.conceptTakeaways.innerHTML = '';
            if (concept.takeaways && concept.takeaways.length > 0) {
                concept.takeaways.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    elements.conceptTakeaways.appendChild(li);
                });
                elements.conceptTakeaways.parentNode.style.display = 'block';
            } else {
                 elements.conceptTakeaways.parentNode.style.display = 'none';
            }

            // Carica Note
            const savedNotes = localStorage.getItem(`codexNote_${conceptId}`);
            elements.notesTextarea.value = savedNotes || '';

            elements.conceptDetails.style.display = 'block';
            markAsRead(conceptId); // Marca come letto quando visualizzato
        }

        // Gestione link interni
        function handleInternalLink(conceptId, event) {
            event.preventDefault();
            displayConceptDetails(conceptId);
            document.querySelectorAll('#concept-list li').forEach(li => {
                li.classList.toggle('active', li.dataset.id === conceptId);
            });
            const activeLi = elements.conceptList.querySelector(`li[data-id="${conceptId}"]`);
            if (activeLi) activeLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Renderizza lista concetti
        function renderConceptList() {
            const searchTerm = currentSearch.toLowerCase();
            elements.conceptList.innerHTML = '';

            const filteredData = conceptsData.filter(concept => {
                const matchesSearch = concept.name.toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || concept.category === currentFilter;
                return matchesSearch && matchesFilter;
            });

            if (filteredData.length === 0) {
                 elements.conceptList.innerHTML = '<li style="font-style: italic; color: var(--text-muted); cursor: default;">Nessun concetto trovato.</li>';
                 return;
            }

            filteredData.forEach(concept => {
                const listItem = document.createElement('li');
                listItem.dataset.id = concept.id;
                listItem.dataset.category = concept.category;
                if (reviewedConcepts[concept.id]) {
                    listItem.classList.add('read');
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'concept-item-content';

                const indicator = document.createElement('span');
                indicator.className = `category-indicator cat-${concept.category.toLowerCase()}`;
                contentDiv.appendChild(indicator);

                const nameSpan = document.createElement('span');
                nameSpan.textContent = concept.name;
                contentDiv.appendChild(nameSpan);

                listItem.appendChild(contentDiv);

                // Aggiungi indicatore letto (checkmark)
                const readMark = document.createElement('span');
                readMark.className = 'read-indicator';
                readMark.innerHTML = '&#10004;'; // Checkmark symbol
                listItem.appendChild(readMark);


                listItem.addEventListener('click', () => {
                    document.querySelectorAll('#concept-list li').forEach(li => li.classList.remove('active'));
                    listItem.classList.add('active');
                    displayConceptDetails(concept.id);
                });
                elements.conceptList.appendChild(listItem);
            });
        }

         // Renderizza domande valutazione
         function renderAssessmentQuestions() {
            elements.assessmentQuestionsContainer.innerHTML = '';
            assessmentQuestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'assessment-question';
                div.innerHTML = `
                    <p>${index + 1}. ${item.q}</p>
                    <label>
                        <input type="radio" name="q${index}" value="1" required> Sono d'accordo
                    </label>
                    <label>
                        <input type="radio" name="q${index}" value="0"> Non sono d'accordo
                    </label>
                `;
                elements.assessmentQuestionsContainer.appendChild(div);
            });
         }

         // Calcola e mostra risultati valutazione + Suggerimenti
         function submitAssessment() {
            let score = 0;
            let answeredQuestions = 0;
            const totalQuestions = assessmentQuestions.length;
            const incorrectFocusAreas = new Set(); // Usa un Set per evitare duplicati

            assessmentQuestions.forEach((item, index) => {
                const selected = elements.assessmentQuestionsContainer.querySelector(`input[name="q${index}"]:checked`);
                if (selected) {
                    answeredQuestions++;
                    const answerValue = parseInt(selected.value);
                    let isCorrect = (answerValue === 1 && item.score_for_agree === 1) || (answerValue === 0 && item.score_for_agree === 0);
                    if (isCorrect) {
                        score++;
                    } else if (item.focus) {
                        // Se la risposta è sbagliata, aggiungi le aree focus correlate
                        item.focus.forEach(areaId => incorrectFocusAreas.add(areaId));
                    }
                }
            });

            if (answeredQuestions < totalQuestions) { alert("Per favore, rispondi a tutte le domande."); return; }

            const percentage = Math.round((score / totalQuestions) * 100);
            let interpretation = '';
            let actionSuggestions = [];

            if (percentage >= 85) {
                interpretation = `Eccellente (${percentage}%). La tua mentalità è fortemente allineata con i principi chiave. Mantieni la consapevolezza e la disciplina.`;
                actionSuggestions = ["Rivedi periodicamente le 5 Verità per rafforzarle.", "Concentrati sull'esecuzione impeccabile del tuo edge.", "Monitora eventuali segni di eccessiva sicurezza (euforia)."];
            } else if (percentage >= 60) {
                interpretation = `Buono (${percentage}%). Hai una buona base, ma ci sono aree di miglioramento. Lavora sui conflitti evidenziati dalle risposte non allineate.`;
                actionSuggestions = ["Identifica le domande a cui hai risposto in modo non allineato.", "Clicca sui concetti suggeriti qui sotto per ripassare.", "Pratica l'esercizio del Cap. 11 per integrare le verità fondamentali."];
            } else {
                interpretation = `Area Critica (${percentage}%). Sono presenti conflitti significativi che probabilmente limitano la tua consistenza. È cruciale un lavoro profondo sulle credenze e l'accettazione del rischio.`;
                 actionSuggestions = ["Studia a fondo i concetti relativi alle 5 Verità e all'Accettazione del Rischio.", "Considera seriamente l'esercizio del Cap. 11 come priorità.", "Lavora sull'identificazione e disattivazione delle credenze limitanti.", "Sii paziente, la trasformazione richiede tempo e impegno."];
            }

            // Aggiungi suggerimenti basati sulle aree sbagliate
            if (incorrectFocusAreas.size > 0) {
                 actionSuggestions.push("Focalizzati in particolare sui seguenti concetti:");
                 incorrectFocusAreas.forEach(areaId => {
                     const concept = conceptsData.find(c => c.id === areaId);
                     if (concept) {
                          actionSuggestions.push(`<li><a href="#${concept.id}" onclick="handleInternalLink('${concept.id}', event)">${concept.name}</a></li>`);
                     }
                 });
                 // Rimuove l'ultimo suggerimento se è solo l'intestazione
                 if (actionSuggestions[actionSuggestions.length - incorrectFocusAreas.size -1] === "Focalizzati in particolare sui seguenti concetti:" && incorrectFocusAreas.size === 0){
                    actionSuggestions.pop();
                 }
            }


            elements.resultsText.textContent = interpretation;
            elements.resultsActions.innerHTML = actionSuggestions.map(s => s.startsWith('<li>') ? s : `<li>${s}</li>`).join(''); // Aggiunge <li> se non già presente
            elements.assessmentResultsContainer.style.display = 'block';

            localStorage.setItem('traderCodexAssessmentResult', JSON.stringify({ score, totalQuestions, interpretation, actionSuggestions }));
            localStorage.setItem('traderCodexAssessmentTaken', 'true');
            elements.submitAssessmentButton.style.display = 'none';
            elements.assessmentQuestionsContainer.style.display = 'none';
        }

        // Carica risultati
         function loadAssessmentResults() {
             const hasTaken = localStorage.getItem('traderCodexAssessmentTaken');
             if (hasTaken === 'true') {
                 const savedResult = localStorage.getItem('traderCodexAssessmentResult');
                 if (savedResult) {
                     try {
                         const result = JSON.parse(savedResult);
                         elements.resultsText.textContent = result.interpretation || "Risultati precedenti caricati.";
                         elements.resultsActions.innerHTML = (result.actionSuggestions || []).map(s => s.startsWith('<li>') ? s : `<li>${s}</li>`).join('');
                         elements.assessmentResultsContainer.style.display = 'block';
                         elements.assessmentQuestionsContainer.style.display = 'none';
                         elements.submitAssessmentButton.style.display = 'none';
                         return true;
                     } catch (e) { /* Ignora errore e procede a mostrare domande */ }
                 }
             }
             // Se non caricati, assicurati che le domande siano visibili e i risultati nascosti
             elements.assessmentQuestionsContainer.style.display = 'block';
             elements.assessmentResultsContainer.style.display = 'none';
             elements.submitAssessmentButton.style.display = 'block';
             return false;
         }


        // Reset valutazione
        function resetAssessment() {
            if (confirm("Sei sicuro di voler cancellare i risultati della valutazione e ripeterla?")) {
                localStorage.removeItem('traderCodexAssessmentResult');
                localStorage.removeItem('traderCodexAssessmentTaken');
                elements.assessmentResultsContainer.style.display = 'none';
                renderAssessmentQuestions(); // Prepara nuove domande
                elements.assessmentQuestionsContainer.style.display = 'block';
                elements.submitAssessmentButton.style.display = 'block';
            }
        }

        // Salva note
        function saveNotes() {
            if (currentConceptId) {
                localStorage.setItem(`codexNote_${currentConceptId}`, elements.notesTextarea.value);
                alert('Note salvate!'); // Feedback visivo semplice
            }
        }

        // Pulisci note
        function clearNotes() {
             if (currentConceptId && confirm("Sei sicuro di voler cancellare le note per questo concetto?")) {
                localStorage.removeItem(`codexNote_${currentConceptId}`);
                elements.notesTextarea.value = '';
             }
        }

        // --- EVENT LISTENERS ---
        elements.searchInput.addEventListener('input', (e) => { currentSearch = e.target.value; renderConceptList(); });
        elements.filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentFilter = e.target.dataset.category;
                elements.filterButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderConceptList();
            }
        });
        elements.assessmentToggleButton.addEventListener('click', () => {
            const isAssessmentVisible = elements.assessmentArea.style.display === 'block';
            elements.conceptDetails.style.display = 'none';
            elements.placeholder.style.display = 'none';
            if (isAssessmentVisible) {
                elements.assessmentArea.style.display = 'none';
                elements.placeholder.style.display = 'block'; // Mostra placeholder se chiudo assessment
                elements.rightPanelHeader.textContent = "Dettagli Concetto"; // Resetta titolo
            } else {
                elements.assessmentArea.style.display = 'block';
                elements.rightPanelHeader.textContent = "Valutazione Mentalità";
                if (!loadAssessmentResults()) {
                    renderAssessmentQuestions();
                }
            }
        });
        elements.submitAssessmentButton.addEventListener('click', submitAssessment);
        elements.resetAssessmentButton.addEventListener('click', resetAssessment);
        elements.saveNotesButton.addEventListener('click', saveNotes);
        elements.clearNotesButton.addEventListener('click', clearNotes);

        // --- INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
             renderConceptList();
             const firstConceptItem = elements.conceptList.querySelector('li');
             if (firstConceptItem && firstConceptItem.dataset.id && localStorage.getItem('traderCodexAssessmentTaken') !== 'true') {
                 firstConceptItem.classList.add('active');
                 displayConceptDetails(firstConceptItem.dataset.id);
             } else if (localStorage.getItem('traderCodexAssessmentTaken') === 'true') {
                 elements.assessmentToggleButton.click(); // Mostra assessment se già fatto
             } else {
                 elements.placeholder.style.display = 'block';
             }
        });
    </script>

</body>
</html>